.MODEL TINY
.CODE
ORG 100h

START:
    ; Получить версию DOS
    MOV AX, 0DC2h       ; Функция получения версии DOS (недокументированная)
    INT 21h
    
    ; Сохранить ES и BX
    PUSH ES
    PUSH BX
    
    ; Получить вектор прерывания 35h (INT 35h)
    MOV AX, 3561h       ; AH=35h (получить вектор), AL=61h (номер прерывания)
    INT 21h
    
    ; Сохранить адрес обработчика
    PUSH ES             ; Сегмент обработчика
    POP DS              ; DS = сегмент обработчика
    PUSH BX             ; Смещение обработчика
    POP DX              ; DX = смещение обработчика
    
    ; Установить новый вектор прерывания 1Ch (системный таймер)
    MOV AX, 251Ch       ; AH=25h (установить вектор), AL=1Ch (системный таймер)
    INT 21h
    
    ; Работа с BIOS Data Area
    PUSH ES             ; Сохранить ES
    XOR AX, AX          ; AX = 0
    MOV ES, AX          ; ES = 0 (сегмент BIOS Data Area)
    
    ; Обращение к флагу состояния клавиатуры
    MOV DI, 417h        ; Адрес флага состояния клавиатуры в BIOS Data Area
    MOV AL, ES:[DI]     ; Загрузить текущее значение флага
    AND AL, 0EFh        ; Сбросить бит 4 (отключить Scroll Lock индикатор)
    MOV ES:[DI], AL     ; Записать измененное значение обратно
    
    ; Восстановить ES
    POP ES
    
    ; Освобождение памяти
    POP AX              ; Восстановить значение (возможно размер блока)
    POP ES              ; Восстановить ES
    SUB AX, 2           ; Уменьшить размер на 2
    MOV DI, AX          ; DI = новый размер
    MOV AX, ES:[DI]     ; Загрузить значение из памяти
    DEC AX              ; Уменьшить на 1
    MOV ES, AX          ; Установить ES
    
    ; Освободить блок памяти
    MOV AH, 49h         ; Функция освобождения памяти
    INT 21h
    
    ; Проверить результат
    JAE EXIT_SUCCESS    ; Если CF=0, то успех
    
    ; Вывести код ошибки
    ADD AL, 30h         ; Преобразовать в ASCII цифру
    MOV DL, AL          ; DL = символ для вывода
    MOV AH, 02h         ; Функция вывода символа
    INT 21h
    
EXIT_SUCCESS:
    ; Завершить программу
    MOV AX, 4C00h       ; Функция завершения программы с кодом 0
    INT 21h

END START
